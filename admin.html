<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>placetalk — admin</title>
<style>
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#0f0f10;color:#f2f2f3}
.wrap{max-width:1100px;margin:0 auto;padding:28px 18px}
.card{border:1px solid #2a2a2c;border-radius:18px;background:#121214;padding:18px}
h1{margin:0 0 12px;font-size:20px}
input{width:100%;padding:12px;border-radius:14px;border:1px solid #2a2a2c;background:#0f0f11;color:#f2f2f3;outline:none}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
button{padding:12px 14px;border-radius:14px;border:1px solid #2a2a2c;background:#18181a;color:#f2f2f3;cursor:pointer}
button:hover{background:#202023}
.list{margin-top:14px;display:grid;gap:10px}
.item{border:1px solid #2a2a2c;border-radius:16px;background:#151517;padding:14px}
.m{color:#b4b4b8;font-size:13px;margin-top:6px}
.badge{display:inline-block;padding:6px 10px;border:1px solid #2a2a2c;border-radius:999px;background:#232325;color:#b4b4b8;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>placetalk — админка (жалобы)</h1>
    <div class="m">Загружает последние 100 жалоб. Пока только просмотр.</div>

    <div class="row">
      <input id="url" placeholder="SUPABASE_URL (https://...supabase.co)" />
      <input id="key" placeholder="SUPABASE anon key (eyJ... роль anon)" />
    </div>

    <div class="row">
      <button id="load">Загрузить жалобы</button>
    </div>

    <div class="list" id="list"></div>
  </div>
</div>

<script>
const list = document.getElementById("list");

function headers(key){
  return { apikey:key, Authorization:`Bearer ${key}`, Accept:"application/json" };
}

function esc(s){
  return String(s).replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

async function rest(url,key,path){
  const r = await fetch(url + "/rest/v1" + path, { headers: headers(key) });
  const t = await r.text();
  if(!r.ok) throw new Error(t);
  return t ? JSON.parse(t) : null;
}

document.getElementById("load").onclick = async () => {
  const url = document.getElementById("url").value.trim();
  const key = document.getElementById("key").value.trim();
  if(!url || !key){ alert("Вставь URL и anon key"); return; }

  try{
    const reps = await rest(url, key,
      "/reports?select=id,target_type,target_id,reason,reporter,created_at&order=created_at.desc&limit=100"
    );

    list.innerHTML = "";
    if(!reps || reps.length === 0){
      list.innerHTML = `<div class="item">Жалоб пока нет.</div>`;
      return;
    }

    reps.forEach(r=>{
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div>
          <span class="badge">${esc(r.target_type)}</span>
          <span class="badge">${esc(r.target_id)}</span>
        </div>
        <div style="margin-top:10px">${esc(r.reason)}</div>
        <div class="m">от @${esc(r.reporter)} • ${esc(new Date(r.created_at).toLocaleString())}</div>
      `;
      list.appendChild(el);
    });

  } catch(e){
    alert("Ошибка: " + e.message);
  }
};
</script>
</body>
</html>
